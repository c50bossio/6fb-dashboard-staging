# Redis Configuration for 6FB AI Agent System Production
# Security-hardened configuration for session management and caching

# =============================================================================
# NETWORK AND SECURITY
# =============================================================================

# Bind to all interfaces (Docker will handle network isolation)
bind 0.0.0.0

# Port configuration
port 6379

# Disable protected mode (we're using password authentication)
protected-mode no

# Authentication (password will be set via environment variable)
# requirepass will be set via command line argument

# =============================================================================
# GENERAL CONFIGURATION
# =============================================================================

# Set the number of databases
databases 16

# TCP listen backlog
tcp-backlog 511

# Close the connection after a client is idle for N seconds
timeout 300

# TCP keepalive
tcp-keepalive 300

# =============================================================================
# LOGGING
# =============================================================================

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (empty string logs to stdout for Docker)
logfile ""

# Enable syslog
syslog-enabled no

# =============================================================================
# PERSISTENCE CONFIGURATION
# =============================================================================

# Save snapshots
save 900 1    # Save if at least 1 key changed in 900 seconds
save 300 10   # Save if at least 10 keys changed in 300 seconds  
save 60 10000 # Save if at least 10000 keys changed in 60 seconds

# Stop writes on bgsave error
stop-writes-on-bgsave-error yes

# Compress string objects using LZF when dump
rdbcompression yes

# Checksum the RDB file
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory
dir /data

# =============================================================================
# APPEND ONLY FILE (AOF) CONFIGURATION
# =============================================================================

# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# AOF fsync policy: always, everysec, no
appendfsync everysec

# Rewrite AOF when it grows by this percentage
auto-aof-rewrite-percentage 100

# Minimum size for AOF rewrite
auto-aof-rewrite-min-size 64mb

# Load truncated AOF file on startup
aof-load-truncated yes

# Use RDB-AOF hybrid persistence
aok-use-rdb-preamble yes

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Maximum memory usage (will be set by Docker container limits)
# maxmemory <bytes>

# Memory eviction policy
maxmemory-policy allkeys-lru

# Memory usage samples for LRU
maxmemory-samples 5

# =============================================================================
# LAZY FREEING
# =============================================================================

# Lazy freeing of memory
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# Lazy freeing on replica side
replica-lazy-flush yes

# =============================================================================
# SECURITY HARDENING
# =============================================================================

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_b833b8fa-3d0d-4a1c-9c6e-5a2f8b7e9d1a"  # Rename to random string
rename-command SHUTDOWN "SHUTDOWN_a7f4c2e8-9b1d-4c5a-8e7f-2a3b6c9e1d4f"
rename-command EVAL ""
rename-command DEL ""

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =============================================================================
# SLOW LOG
# =============================================================================

# Slow log configuration
slowlog-log-slower-than 10000  # Log queries slower than 10ms
slowlog-max-len 128            # Maximum slow log entries

# =============================================================================
# CLIENT CONNECTIONS
# =============================================================================

# Maximum number of connected clients
maxclients 10000

# =============================================================================
# ADVANCED CONFIGURATION
# =============================================================================

# Hash settings
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog settings
hll-sparse-max-bytes 3000

# Streams settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# =============================================================================
# REPLICATION CONFIGURATION
# =============================================================================

# Master authentication (for replication)
# masterauth <password>

# Replica read-only
replica-read-only yes

# Replica serve stale data
replica-serve-stale-data yes

# Replica priority
replica-priority 100

# =============================================================================
# LUA SCRIPTING
# =============================================================================

# Lua time limit in milliseconds
lua-time-limit 5000

# =============================================================================
# REDIS CLUSTER (if needed)
# =============================================================================

# Enable cluster mode (disabled by default)
# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000

# =============================================================================
# LATENCY MONITORING
# =============================================================================

# Latency threshold in milliseconds
latency-monitor-threshold 100

# =============================================================================
# EVENT NOTIFICATION
# =============================================================================

# Keyspace notifications (disabled for performance)
notify-keyspace-events ""

# =============================================================================
# ADVANCED MEMORY OPTIMIZATION
# =============================================================================

# Memory optimization for small aggregates
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# =============================================================================
# ADDITIONAL SECURITY MEASURES
# =============================================================================

# Disable potentially dangerous commands
rename-command MONITOR ""
rename-command SYNC ""
rename-command PSYNC ""

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# I/O threads (Redis 6.0+)
# io-threads 4
# io-threads-do-reads yes

# Disable THP (Transparent Huge Pages) support
disable_thp yes

# =============================================================================
# SESSION MANAGEMENT SPECIFIC SETTINGS
# =============================================================================

# Default key expiration for sessions (30 minutes)
# This will be managed by the application, but set as fallback
# Keys will be created with TTL by the application

# =============================================================================
# MONITORING AND STATS
# =============================================================================

# Enable statistics
# Stats will be collected by monitoring systems

# =============================================================================
# SSL/TLS CONFIGURATION (if needed)
# =============================================================================

# Enable TLS (uncomment if using TLS)
# port 0
# tls-port 6380
# tls-cert-file /etc/redis/tls/redis.crt
# tls-key-file /etc/redis/tls/redis.key
# tls-ca-cert-file /etc/redis/tls/ca.crt
# tls-dh-params-file /etc/redis/tls/redis.dh
# tls-protocols "TLSv1.2 TLSv1.3"

# =============================================================================
# CONFIGURATION VALIDATION
# =============================================================================

# Redis will validate configuration on startup
# Any errors will prevent Redis from starting

# =============================================================================
# NOTES FOR PRODUCTION DEPLOYMENT
# =============================================================================

# 1. Password Authentication:
#    - The requirepass will be set via Docker environment variable
#    - Never store passwords in this configuration file
#
# 2. Memory Limits:
#    - Set maxmemory based on container limits
#    - Monitor memory usage in production
#
# 3. Persistence:
#    - Both RDB and AOF are enabled for durability
#    - Regular backups should be implemented
#
# 4. Security:
#    - Dangerous commands are disabled or renamed
#    - Client connections are limited
#    - Network isolation provided by Docker
#
# 5. Monitoring:
#    - Slow log is enabled for performance monitoring
#    - Latency monitoring is configured
#    - Statistics can be collected via INFO commands
#
# 6. Session Management:
#    - Optimized for session storage and retrieval
#    - Automatic expiration of session keys
#    - Memory-efficient data structures