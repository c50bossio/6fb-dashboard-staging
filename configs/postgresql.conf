# PostgreSQL Configuration for Production Security
# Optimized for security, performance, and compliance

# =============================================================================
# CONNECTION AND AUTHENTICATION
# =============================================================================

# Connection Settings
listen_addresses = '*'                    # Listen on all addresses (Docker network)
port = 5432                              # Default PostgreSQL port
max_connections = 100                    # Maximum concurrent connections
superuser_reserved_connections = 3       # Reserved connections for superuser

# Authentication
password_encryption = scram-sha-256      # Use SCRAM-SHA-256 for password encryption
ssl = on                                 # Enable SSL connections
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL' # Strong SSL ciphers only
ssl_prefer_server_ciphers = on           # Prefer server cipher order
ssl_min_protocol_version = 'TLSv1.2'    # Minimum TLS version
ssl_max_protocol_version = 'TLSv1.3'    # Maximum TLS version

# =============================================================================
# SECURITY SETTINGS
# =============================================================================

# Statement Timeout
statement_timeout = 300000               # 5 minutes timeout for statements
lock_timeout = 60000                     # 1 minute timeout for locks
idle_in_transaction_session_timeout = 600000  # 10 minutes idle timeout

# Connection Security
tcp_keepalives_idle = 600               # TCP keepalive idle time (10 minutes)
tcp_keepalives_interval = 30            # TCP keepalive interval (30 seconds)
tcp_keepalives_count = 3                # TCP keepalive probes

# Row Level Security
row_security = on                       # Enable row level security

# =============================================================================
# LOGGING AND AUDITING
# =============================================================================

# Logging Configuration
logging_collector = on                   # Enable logging collector
log_destination = 'stderr'              # Log to stderr for Docker
log_directory = 'log'                   # Log directory
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'  # Log filename pattern
log_file_mode = 0600                    # Log file permissions
log_rotation_age = 1d                   # Rotate logs daily
log_rotation_size = 100MB               # Rotate logs at 100MB
log_truncate_on_rotation = off          # Don't truncate on rotation

# What to Log
log_connections = on                    # Log connections
log_disconnections = on                 # Log disconnections
log_duration = on                       # Log statement duration
log_statement = 'all'                  # Log all statements (for security audit)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '  # Log prefix format
log_lock_waits = on                     # Log lock waits
log_temp_files = 0                      # Log all temporary files
log_autovacuum_min_duration = 0         # Log all autovacuum activity

# Error Reporting
log_error_verbosity = default           # Default error verbosity
log_min_error_statement = error         # Log statements that cause errors
log_min_duration_statement = 1000       # Log statements taking >1 second

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# Memory Settings
shared_buffers = 256MB                  # Shared buffer pool size
effective_cache_size = 1GB              # Effective cache size
work_mem = 4MB                          # Working memory for sorts/joins
maintenance_work_mem = 64MB             # Memory for maintenance operations
max_wal_size = 1GB                      # Maximum WAL size
min_wal_size = 80MB                     # Minimum WAL size

# Checkpoint Settings
checkpoint_completion_target = 0.9      # Checkpoint completion target
checkpoint_timeout = 5min               # Checkpoint timeout
wal_buffers = 16MB                      # WAL buffer size

# Query Planning
random_page_cost = 1.1                  # Random page cost (SSD optimized)
effective_io_concurrency = 200          # Effective I/O concurrency

# =============================================================================
# WRITE-AHEAD LOGGING (WAL)
# =============================================================================

# WAL Settings
wal_level = replica                     # WAL level for replication
fsync = on                             # Force synchronization
synchronous_commit = on                # Synchronous commit
wal_sync_method = fsync                # WAL sync method
full_page_writes = on                  # Full page writes
wal_compression = on                   # WAL compression
wal_log_hints = on                     # WAL log hints

# Archive Settings
archive_mode = on                      # Enable WAL archiving
archive_command = 'test ! -f /backup/archive/%f && cp %p /backup/archive/%f'
archive_timeout = 300                  # Archive timeout (5 minutes)

# =============================================================================
# REPLICATION (For High Availability)
# =============================================================================

# Replication Settings
max_wal_senders = 3                    # Maximum WAL senders
wal_keep_size = 1GB                    # Keep WAL segments
hot_standby = on                       # Hot standby mode
hot_standby_feedback = on              # Hot standby feedback

# =============================================================================
# VACUUM AND ANALYZE
# =============================================================================

# Autovacuum Settings
autovacuum = on                        # Enable autovacuum
autovacuum_max_workers = 3             # Maximum autovacuum workers
autovacuum_naptime = 1min              # Autovacuum nap time
autovacuum_vacuum_threshold = 50       # Vacuum threshold
autovacuum_analyze_threshold = 50      # Analyze threshold
autovacuum_vacuum_scale_factor = 0.2   # Vacuum scale factor
autovacuum_analyze_scale_factor = 0.1  # Analyze scale factor
autovacuum_freeze_max_age = 200000000  # Freeze max age
autovacuum_multixact_freeze_max_age = 400000000  # Multixact freeze max age

# =============================================================================
# STATISTICS AND MONITORING
# =============================================================================

# Statistics Settings
track_activities = on                  # Track activities
track_counts = on                      # Track counts
track_io_timing = on                   # Track I/O timing
track_functions = all                  # Track function calls
track_activity_query_size = 1024       # Activity query size

# Shared Preload Libraries
shared_preload_libraries = 'pg_stat_statements'  # Load pg_stat_statements

# pg_stat_statements Configuration
pg_stat_statements.max = 10000         # Maximum statements tracked
pg_stat_statements.track = all         # Track all statements
pg_stat_statements.track_utility = on  # Track utility statements
pg_stat_statements.save = on           # Save statistics across restarts

# =============================================================================
# ERROR HANDLING
# =============================================================================

# Client Connection Defaults
default_transaction_isolation = 'read committed'  # Default isolation level
search_path = '"$user", public'        # Default search path
default_tablespace = ''                # Default tablespace
temp_tablespaces = ''                  # Temporary tablespaces

# Locale and Formatting
datestyle = 'iso, mdy'                 # Date style
timezone = 'UTC'                       # Timezone
lc_messages = 'en_US.utf8'            # Messages locale
lc_monetary = 'en_US.utf8'            # Monetary locale
lc_numeric = 'en_US.utf8'             # Numeric locale
lc_time = 'en_US.utf8'                # Time locale
default_text_search_config = 'pg_catalog.english'  # Text search config

# =============================================================================
# SECURITY EXTENSIONS
# =============================================================================

# Additional Security Extensions (loaded via shared_preload_libraries)
# - pg_audit: Comprehensive auditing
# - passwordcheck: Password strength checking
# - auth_delay: Delay on authentication failure

# =============================================================================
# CUSTOM SECURITY SETTINGS
# =============================================================================

# Custom Variables for Application
custom_variable_classes = ''           # Custom variable classes

# Application Security
# These would be set by the application connection string or user
# - application_name: Set by client for tracking
# - client_encoding: UTF8 encoding required