<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; }
        iframe { width: 100%; height: 600px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>üîç Registration Form Debug Tool</h1>
    
    <div class="debug-section">
        <h2>Environment Check</h2>
        <button onclick="checkEnvironment()">Check Environment Variables</button>
        <div id="env-results"></div>
    </div>
    
    <div class="debug-section">
        <h2>Supabase Connection Test</h2>
        <button onclick="testSupabaseConnection()">Test Supabase Connection</button>
        <div id="supabase-results"></div>
    </div>
    
    <div class="debug-section">
        <h2>Registration Form Test</h2>
        <button onclick="testRegistrationForm()">Open Registration Form</button>
        <button onclick="simulateFormSubmission()">Simulate Form Submission</button>
        <div id="form-results"></div>
    </div>
    
    <div class="debug-section">
        <h2>Live Registration Page</h2>
        <iframe id="registration-frame" src="http://localhost:9999/register"></iframe>
    </div>
    
    <div class="debug-section">
        <h2>Console Logs</h2>
        <div id="console-logs" style="max-height: 300px; overflow-y: auto; background: #f0f0f0; padding: 10px;"></div>
    </div>

    <script>
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLogEntry(type, message) {
            const logsDiv = document.getElementById('console-logs');
            const entry = document.createElement('div');
            entry.className = type;
            entry.innerHTML = `<strong>[${type.toUpperCase()}]</strong> ${new Date().toLocaleTimeString()}: ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLogEntry('info', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLogEntry('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLogEntry('warning', args.join(' '));
        };
        
        async function checkEnvironment() {
            const resultsDiv = document.getElementById('env-results');
            resultsDiv.innerHTML = '<p>Checking environment...</p>';
            
            try {
                const response = await fetch('http://localhost:9999/api/debug/env');
                if (response.ok) {
                    const data = await response.text();
                    resultsDiv.innerHTML = `<pre class="success">${data}</pre>`;
                } else {
                    resultsDiv.innerHTML = `<p class="error">Failed to check environment: ${response.status}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">Environment check failed: ${error.message}</p>`;
            }
        }
        
        async function testSupabaseConnection() {
            const resultsDiv = document.getElementById('supabase-results');
            resultsDiv.innerHTML = '<p>Testing Supabase connection...</p>';
            
            try {
                // This will be executed in the iframe context
                const frame = document.getElementById('registration-frame');
                const message = {
                    type: 'TEST_SUPABASE',
                    payload: {}
                };
                frame.contentWindow.postMessage(message, '*');
                
                // Listen for response
                window.addEventListener('message', function(event) {
                    if (event.data.type === 'SUPABASE_TEST_RESULT') {
                        resultsDiv.innerHTML = `<pre class="info">${JSON.stringify(event.data.payload, null, 2)}</pre>`;
                    }
                });
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">Supabase test failed: ${error.message}</p>`;
            }
        }
        
        function testRegistrationForm() {
            const resultsDiv = document.getElementById('form-results');
            resultsDiv.innerHTML = '<p class="info">Opening registration form in new tab for manual testing...</p>';
            window.open('http://localhost:9999/register', '_blank');
        }
        
        async function simulateFormSubmission() {
            const resultsDiv = document.getElementById('form-results');
            resultsDiv.innerHTML = '<p>Simulating form submission...</p>';
            
            try {
                const formData = {
                    firstName: 'John',
                    lastName: 'Doe',
                    email: 'john.doe.test@gmail.com',
                    phone: '(555) 123-4567',
                    password: 'TestPassword123',
                    confirmPassword: 'TestPassword123',
                    businessName: 'Test Barbershop',
                    businessAddress: '123 Main Street, Test City, TS 12345',
                    businessPhone: '(555) 987-6543',
                    businessType: 'barbershop',
                    selectedPlan: 'professional'
                };
                
                console.log('Attempting to simulate registration with data:', formData);
                
                // Send message to iframe to simulate form submission
                const frame = document.getElementById('registration-frame');
                const message = {
                    type: 'SIMULATE_REGISTRATION',
                    payload: formData
                };
                frame.contentWindow.postMessage(message, '*');
                
                resultsDiv.innerHTML = '<p class="info">Form submission simulation sent to iframe. Check console and network tab for results.</p>';
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">Form simulation failed: ${error.message}</p>`;
                console.error('Form simulation error:', error);
            }
        }
        
        // Listen for messages from iframe
        window.addEventListener('message', function(event) {
            if (event.origin !== 'http://localhost:9999') return;
            
            console.log('Received message from iframe:', event.data);
            
            if (event.data.type === 'REGISTRATION_RESULT') {
                const resultsDiv = document.getElementById('form-results');
                const result = event.data.payload;
                
                if (result.success) {
                    resultsDiv.innerHTML += `<p class="success">Registration successful: ${result.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<p class="error">Registration failed: ${result.error}</p>`;
                }
            }
        });
        
        // Initialize
        console.log('Registration Debug Tool loaded');
        console.log('Environment:', window.location.href);
    </script>
</body>
</html>